# ğŸ“„ ê¸°ìˆ  ë¶„ì„ ë ˆí¬íŠ¸: WebSocket ê¸°ë°˜ 1:1 ì±„íŒ… ì‹œìŠ¤í…œ

## 1. ì „ì²´ ì•„í‚¤í…ì²˜ (The Big Picture)

ì´ ì½”ë“œëŠ” **ë©”ì‹œì§€ ì „ì†¡ì€ HTTP, ìˆ˜ì‹ ì€ WebSocket**ì´ë¼ëŠ” ë…íŠ¹í•˜ì§€ë§Œ íš¨ìœ¨ì ì¸ êµ¬ì¡°ë¥¼ ë”°ë¥´ê³  ìˆìŠµë‹ˆë‹¤. WebSocketì„ ì–‘ë°©í–¥ í†µì‹ (ì „ì†¡/ìˆ˜ì‹  ëª¨ë‘)ì— ì‚¬ìš©í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì´ ì˜ˆì œì—ì„œëŠ” WebSocketì„ ì£¼ë¡œ **ìˆ˜ì‹  ì „ìš© ì±„ë„**ë¡œ í™œìš©í•©ë‹ˆë‹¤.

### ğŸ”„ ë°ì´í„° íë¦„ë„

1. **ì—°ê²° (Connection):** ì‚¬ìš©ì(Receiver)ê°€ ë¸Œë¼ìš°ì €ë¥¼ ì¼œë©´ WebSocketì„ í†µí•´ ì„œë²„ì™€ **ì§€ì†ì ì¸ ì—°ê²°(í„°ë„)**ì„ ëš«ì–´ë†“ìŠµë‹ˆë‹¤.
2. **ë°œì†¡ (Sending):** ì‚¬ìš©ì(Sender)ê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•ŒëŠ” WebSocketì´ ì•„ë‹Œ ì¼ë°˜ **HTTP POST ìš”ì²­(API Call)**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
3. **ì¤‘ê³„ (Routing):** ì„œë²„ëŠ” APIë¡œ ë“¤ì–´ì˜¨ ë©”ì‹œì§€ë¥¼ ë°›ì•„, ë©”ëª¨ë¦¬ì— ì €ì¥ëœ WebSocket ì—°ê²° ëª©ë¡ì—ì„œ ìˆ˜ì‹ ì(Receiver)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
4. **ìˆ˜ì‹  (Receiving):** ì„œë²„ëŠ” ì°¾ì€ ìˆ˜ì‹ ìì˜ WebSocket í„°ë„ì„ í†µí•´ ì¦‰ì‹œ ë©”ì‹œì§€ë¥¼ **í‘¸ì‹œ(Push)**í•©ë‹ˆë‹¤.

> **ğŸ’¡ í•µì‹¬ ìš”ì•½:**
> * **ë³´ë‚¼ ë•Œ:** ìš°ì²´í†µì— í¸ì§€ë¥¼ ë„£ë“¯ APIë¥¼ í˜¸ì¶œ (HTTP)
> * **ë°›ì„ ë•Œ:** ì „í™”ê¸°ì²˜ëŸ¼ ì—°ê²°ëœ ì„ ì„ í†µí•´ ì¦‰ì‹œ ìˆ˜ì‹  (WebSocket)


## 2. ì½”ë“œ ìƒì„¸ ë¶„ì„ (Deep Dive)

### ğŸ–¥ï¸ Backend (FastAPI)

ë°±ì—”ë“œì˜ í•µì‹¬ì€ **ëˆ„ê°€ ì–´ë–¤ ì†Œì¼“ì— ì—°ê²°ë˜ì–´ ìˆëŠ”ê°€?** ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

#### A. ì—°ê²° ê´€ë¦¬ì (`ConnectionManager`)

ì´ í´ë˜ìŠ¤ëŠ” ì „í™” êµí™˜ì› ì—­í• ì„ í•©ë‹ˆë‹¤.

```python
class ConnectionManager:
    def __init__(self):
        # í•µì‹¬: ì‚¬ìš©ì IDë¥¼ í‚¤(Key), ì†Œì¼“ ê°ì²´ë¥¼ ê°’(Value)ìœ¼ë¡œ ì €ì¥
        self.active_connections: Dict[str, WebSocket] = {}

    async def connect(self, websocket: WebSocket, user_id: str):
        await websocket.accept()  # 1. í•¸ë“œì…°ì´í¬ ìŠ¹ì¸ (ì—°ê²° ìˆ˜ë¦½)
        self.active_connections[user_id] = websocket  # 2. ëª…ë¶€ ì‘ì„± (ì €ì¥)

    def disconnect(self, user_id: str):
        # ... (ëª…ë¶€ì—ì„œ ì‚­ì œ)

```

* **`active_connections`**: í˜„ì¬ ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìì˜ ì†Œì¼“ì„ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ íŠ¹ì • ìœ ì €ì—ê²Œë§Œ ê·“ì†ë§ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`websocket.accept()`**: í´ë¼ì´ì–¸íŠ¸ì˜ ì—°ê²° ìš”ì²­ì„ ìŠ¹ì¸í•˜ëŠ” í•„ìˆ˜ ê³¼ì •ì…ë‹ˆë‹¤.

#### B. ìˆ˜ì‹ ìì—ê²Œ ë©”ì‹œì§€ ì „ë‹¬ (`send_personal_message`)

APIë¡œ ë°›ì€ ë©”ì‹œì§€ë¥¼ íŠ¹ì • ì†Œì¼“ìœ¼ë¡œ ì˜ì•„ì£¼ëŠ” ë¡œì§ì…ë‹ˆë‹¤.

```python
    async def send_personal_message(self, message: str, user_id: str):
        if user_id in self.active_connections:
            websocket = self.active_connections[user_id]
            await websocket.send_text(message) # ì†Œì¼“ì„ í†µí•´ í…ìŠ¤íŠ¸ ì „ì†¡

```

* `send_text`: ì—°ê²°ëœ ì†Œì¼“ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.

#### C. WebSocket ì—”ë“œí¬ì¸íŠ¸ (ìˆ˜ì‹  ëŒ€ê¸°ì†Œ)

í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì†ì„ ìœ ì§€í•˜ëŠ” ê³³ì…ë‹ˆë‹¤.

```python
@app.websocket("/ws/{user_id}")
async def websocket_endpoint(websocket: WebSocket, user_id: str):
    await manager.connect(websocket, user_id)
    try:
        while True:
            await websocket.receive_text() # ì—°ê²° ìœ ì§€ë¥¼ ìœ„í•œ ë£¨í”„
    except WebSocketDisconnect:
        manager.disconnect(user_id)

```

* **`while True`**: HTTPì™€ ë‹¬ë¦¬ WebSocketì€ ì—°ê²°ì„ ëŠê¸° ì „ê¹Œì§€ ê³„ì† ìœ ì§€ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ë¬´í•œ ë£¨í”„ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë£¨í”„ê°€ ëë‚˜ë©´ ì—°ê²°ë„ ì¢…ë£Œë©ë‹ˆë‹¤.

#### D. ë©”ì‹œì§€ ë°œì†¡ API (HTTP)

```python
@app.post("/send-message")
async def send_chat_message(chat: ChatMessage):
    # ...
    await manager.send_personal_message(...) # ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì†Œì¼“ìœ¼ë¡œ ì „ë‹¬

```

* ì¼ë°˜ì ì¸ REST APIì…ë‹ˆë‹¤. ì´ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì„œë²„ ë‚´ë¶€ì—ì„œ `manager`ë¥¼ í˜¸ì¶œí•˜ì—¬ ì†Œì¼“ í†µì‹ ì„ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

---

### ğŸ’» Frontend (React)

í”„ë¡ íŠ¸ì—”ë“œëŠ” WebSocketì˜ ìƒíƒœ ê´€ë¦¬ì™€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë‹ì´ í•µì‹¬ì…ë‹ˆë‹¤.

#### A. WebSocket ê°ì²´ ê´€ë¦¬ (`useRef`)

```typescript
const socketRef = useRef<WebSocket | null>(null);

```

* **`useRef`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ :** `useState`ë¥¼ ì‚¬ìš©í•˜ë©´ ì†Œì¼“ ì—°ê²°ì´ ìˆ˜ë¦½ë  ë•Œë§ˆë‹¤ ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ë˜ì–´ ì—°ê²°ì´ ëŠê¸°ê±°ë‚˜ ì¤‘ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `useRef`ëŠ” ë¦¬ë Œë”ë§ ì—†ì´ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•´ì¤ë‹ˆë‹¤.

#### B. ì—°ê²° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (`connectSocket`)

```typescript
const connectSocket = () => {
    // 1. ì†Œì¼“ ìƒì„± (í•¸ë“œì…°ì´í¬ ìš”ì²­)
    const socket = new WebSocket(`ws://localhost:8000/ws/${senderId}`);

    // 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    socket.onopen = () => { ... }      // ì—°ê²° ì„±ê³µ ì‹œ
    socket.onmessage = (e) => {        // ì„œë²„ì—ì„œ ë©”ì‹œì§€ê°€ ì™”ì„ ë•Œ (í•µì‹¬)
        addLog(`ğŸ“© ${e.data}`);
    };
    socket.onclose = () => { ... }     // ì—°ê²° ì¢…ë£Œ ì‹œ
    
    socketRef.current = socket;
};

```

* **`new WebSocket(...)`**: ë¸Œë¼ìš°ì € ë‚´ì¥ APIë¥¼ í†µí•´ ì„œë²„ì˜ `ws://` ì—”ë“œí¬ì¸íŠ¸ë¡œ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
* **`onmessage`**: ì„œë²„ê°€ `await websocket.send_text()`ë¥¼ ì‹¤í–‰í•˜ë©´, ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì´ í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ì–´ ë°ì´í„°ë¥¼ ë°›ìŠµë‹ˆë‹¤.

#### C. ë©”ì‹œì§€ ì „ì†¡ (`sendMessage`)

```typescript
const sendMessage = async () => {
    // ...
    await fetch("http://localhost:8000/send-message", {
        method: "POST",
        // ...
    });
};

```

* ì½”ë“œì—ì„œ ë³´ì‹œë‹¤ì‹œí”¼ `socket.send()`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , `fetch`ë¥¼ í†µí•´ ë³„ë„ì˜ APIë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. ì´ëŠ” ë¡œì§ì˜ ì±…ì„ì„ ë¶„ë¦¬(ì „ì†¡ì€ HTTP, ìˆ˜ì‹ ì€ WS)í•˜ëŠ” ì„¤ê³„ì…ë‹ˆë‹¤.

## 3. ê²°ë¡ 

ì´ ì½”ë“œëŠ” WebSocketì˜ ê¸°ë³¸ì ì¸ **ì—°ê²°(Connect) - ìœ ì§€(Heartbeat) - í•´ì œ(Disconnect)** ìˆ˜ëª… ì£¼ê¸°ë¥¼ ì˜ ë³´ì—¬ì¤ë‹ˆë‹¤.

1. **FastAPI**ëŠ” `ConnectionManager`ë¥¼ í†µí•´ ì†Œì¼“ë“¤ì„ ë©”ëª¨ë¦¬ ë”•ì…”ë„ˆë¦¬ë¡œ ê´€ë¦¬í•˜ë©° íŠ¹ì • ìœ ì €ë¥¼ íƒ€ê²ŸíŒ…í•©ë‹ˆë‹¤.
2. **React**ëŠ” `useRef`ì™€ `onmessage` ì´ë²¤íŠ¸ë¥¼ í†µí•´ ëŠê¹€ ì—†ëŠ” ì‹¤ì‹œê°„ ìˆ˜ì‹  í™˜ê²½ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

ì´ êµ¬ì¡°ëŠ” ì•Œë¦¼ ì‹œìŠ¤í…œ, ì£¼ì‹ ì‹œì„¸ ì •ë³´, 1:1 ì±„íŒ… ë“± **ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ëŠ¥ë™ì ìœ¼ë¡œ ë³´ë‚´ì•¼ í•˜ëŠ” ì„œë¹„ìŠ¤**ì— ë§¤ìš° ì í•©í•œ ê¸°ì´ˆ ëª¨ë¸ì…ë‹ˆë‹¤.


## 4. How to Run

ì´ í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë‘ ê°œì˜ í„°ë¯¸ë„ì´ í•„ìš”í•©ë‹ˆë‹¤ (Backend, Frontend).

### 1. Backend (FastAPI)

ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# 1. ì˜ì¡´ì„± ì„¤ì¹˜
pip install -r requirements.txt

# 2. ì„œë²„ ì‹¤í–‰ (Port: 8000)
python server.py
# ë˜ëŠ”
uvicorn server:app --reload
```

### 2. Frontend (React)

`frontend` ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
cd frontend

# 1. ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì´ˆ 1íšŒ)
npm install

# 2. ë¦¬ì•¡íŠ¸ ì•± ì‹¤í–‰ (Port: 3000)
npm start
```
